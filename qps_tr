####
# Example:
# pt-stalk --variable=qps_tr --threshold=1 --cycles=2 --function /root/stalk-trigger.sh
####

trg_plugin() {

## Pretend there is no load between certain times
suppression_during=0
suppression_start=0330
suppression_end=0400

if [[ "${suppression_during}" -eq 1 ]]; then
        now=$(date +"%H%M")
        if [[ ( "$now" > "$suppression_start" && "$now" < "$suppression_end" ) ]]; then
        echo 0
        exit 0
        fi
fi

mysql -ss <<< "select variable_value into @x from information_schema.global_status where variable_name = 'Questions'; select sleep(1) into @y; select variable_value into @z from information_schema.global_status where variable_name = 'Questions'; select floor((@z-@x)/variable_value) < 1000 as qps_tr from information_schema.global_status where variable_name='Threads_running'"
}

### uncomment below if testing outside pt-stalk
# trg_plugin
